<template>
  <!-- Add Product Button -->
  <lightning-button
    variant="brand"
    label="Add Product"
    title="Add Product"
    onclick={openModal}
    class="slds-m-left_x-small">
  </lightning-button>

  <!-- Modal -->
  <template if:true={isModalOpen}>
    <section
      role="dialog"
      aria-labelledby="modal-heading-01"
      aria-modal="true"
      aria-describedby="modal-content-id-1"
      class="slds-modal slds-fade-in-open">
      
      <div class="slds-modal__container slds-size_large">
        
        <!-- Header -->
        <header class="slds-modal__header">
          <button
            class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
            title="Close"
            onclick={closeModal}>
            <lightning-icon
              icon-name="utility:close"
              alternative-text="close"
              variant="inverse"
              size="small">
            </lightning-icon>
            <span class="slds-assistive-text">Close</span>
          </button>

          <template if:true={isFirstPage}>
            <h2 id="modal-heading-02" class="slds-text-heading_medium">Add Products</h2>
            <h3 id="modal-heading-03">Price Book: {PriceBook}</h3>
          </template>

          <template if:false={isFirstPage}>
            <h2 id="modal-heading-04" class="slds-text-heading_medium">Edit Selected Products</h2>
          </template>
        </header>

        <!-- Content -->
        <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">

          <!-- First Page -->
          <template if:true={isFirstPage}>

            <!-- Search & Filter -->
            <div class="slds-grid slds-gutters slds-p-around_xxx-small">
              <div class="slds-col slds-size_1-of-1">
                <div class="slds-form-element" onmouseleave={toggleResult}>
                  <div class="slds-combobox_container slds-has-selection">
                    <div
                      class="lookupInputContainer slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click"
                      aria-expanded="false"
                      aria-haspopup="listbox"
                      role="combobox">
                      
                      <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_left-right" role="none">
                        <div class="searchBoxWrapper slds-show">
                          <!-- Lookup Input -->
                          <lightning-input
                            type="search"
                            data-source="searchInputField"
                            onclick={toggleResult}
                            value={searchKey}
                            variant="label-hidden"
                            placeholder="Search Product here..."
                            onkeyup={showFilteredProducts}
                            class="searchBox">
                          </lightning-input>
                          <span if:true={showErrorMsg} class="slds-text-color_error">
                            First, enter keywords for a product. Then add filters and click Apply.
                          </span>
                        </div>
                      </div>

                      <!-- Lookup Search Results -->
                      <div style="margin-top:0px;display:none" id="listbox-id-5"
                           class="lookupContainer slds-dropdown slds-dropdown_length-with-icon-7 slds-dropdown_fluid"
                           role="listbox">
                        <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                          <template for:each={lstResult} for:item="obj">
                            <li key={obj.productCode} role="presentation" class="slds-listbox__item">
                              <div
                                data-recid={obj.productCode}
                                onclick={handelSelectedRecord}
                                class="slds-media slds-listbox__option slds-listbox__option_entity slds-listbox__option_has-meta"
                                role="option">
                                <span class="slds-media__figure slds-listbox__option-icon" style="pointer-events: none;">
                                  <span class="slds-icon_container">
                                    <lightning-icon icon-name="standard:product_item" size="small" alternative-text="icon"></lightning-icon>
                                  </span>
                                </span>
                                <span class="slds-media__body" style="pointer-events: none;">
                                  <span class="slds-listbox__option-text slds-listbox__option-text_entity">{obj.Name}</span>
                                  <span class="slds-listbox__option-text slds-listbox__option-text_entity">{obj.ProductCode}</span>
                                </span>
                              </div>
                            </li>
                          </template>
                          <!-- No Records -->
                          <template if:false={hasRecords}>
                            <li class="slds-listbox__item slds-text-align_center slds-text-title_bold">
                              No Records Found...
                            </li>
                          </template>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Filter Button -->
              <div class="slds-col">
                <lightning-button-icon
                  icon-name="utility:filterList"
                  size="medium"
                  onclick={datafilter}
                  alternative-text="Filter"
                  class="slds-m-left_xx-small slds-float_right">
                </lightning-button-icon>
              </div>
            </div>

            <!-- Navigation Links -->
            <div class="slds-grid slds-grid_vertical slds-m-vertical_x-small">
              <a if:true={ShowViewAll} onclick={handleviewAll}
                 class="slds-m-vertical_xx-small slds-col slds-p-around_xx-small">
                Back to Result
              </a>
              <a if:true={ShowSelected} onclick={handleShowSelected}
                 class="slds-m-vertical_xx-small slds-col slds-p-around_xx-small">
                Show Selected ({SelectedRecordCount})
              </a>
            </div>

            <!-- Datatable with Filters -->
            <div class="slds-grid slds-wrap slds-scrollable_y" if:true={datafilterval} style="height:21rem;">
              <div class="slds-size_2-of-3">
                <div class="slds-box_x-small slds-m-around_x-small">
                  <lightning-datatable
                    data={ShowTableData}
                    key-field="ProductCode"
                    columns={cols}
                    selected-rows={selectedProductCode}
                    onrowselection={SelectedProduct}>
                  </lightning-datatable>
                </div>
              </div>

              <!-- Quick Filters -->
              <div class="slds-size_1-of-3">
                <div class="slds-box_x-small slds-m-around_x-small">
                  <div class="slds-panel__header">
                    <h2 class="slds-panel__header-title slds-text-heading_small">Quick Filters</h2>
                  </div>
                  <lightning-input
                    type="text"
                    value={FilterForm.ProductCode}
                    label="Product Code"
                    name="ProductCode"
                    onchange={handleChange}>
                  </lightning-input>
                  <br/>
                  <lightning-checkbox-group
                    name="ProductFamily"
                    label="Product Family"
                    options={options}
                    value={FilterForm.ProductFamily}
                    onchange={handleChange}>
                  </lightning-checkbox-group>
                </div>
                <button class="slds-button slds-button_neutral" onclick={clearFilter}>Cancel</button>
                <button class="slds-button slds-button_brand slds-float_right slds-m-right_medium" onclick={ApplyFilter}>Apply</button>
              </div>
            </div>

            <!-- Datatable without Filters -->
            <div class="slds-grid slds-gutters slds-scrollable_y" style="height:21rem;" if:false={datafilterval}>
              <div class="slds-col slds-box">
                <lightning-datatable
                  data={ShowTableData}
                  key-field="ProductCode"
                  columns={cols}
                  selected-rows={selectedProductCode}
                  onrowselection={SelectedProduct}>
                </lightning-datatable>
              </div>
            </div>
          </template>

          <!-- Second Page -->
          <template if:true={isSecondPage}>
            <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_col-bordered">
              <thead>
                <tr class="slds-line-height_reset">
                  <th scope="col"></th>
                  <th scope="col"><div class="slds-truncate">Item Number</div></th>
                  <th scope="col"><div class="slds-truncate"><span class="slds-required">*</span>Quantity</div></th>
                  <th scope="col"><div class="slds-truncate"><span class="slds-required">*</span>Sales Price</div></th>
                  <th scope="col"><div class="slds-truncate">Date</div></th>
                  <th scope="col"><div class="slds-truncate">Line Description</div></th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody>
                <template for:each={SelectedProductData} for:item="product" for:index="index">
                  <tr key={product.Id} id={product.Id}>
                    <td><div>{index}</div></td>
                    <th scope="row">
                      <div class="slds-truncate" title={product.Name}>
                        <a href={product.purl} tabindex="-1">{product.Name}</a>
                      </div>
                    </th>
                    <td>
                      <lightning-input
                        type="number"
                        value={product.Quantity}
                        placeholder="0"
                        data-target-id={product.Id}
                        onchange={handleQuantityChange}>
                      </lightning-input>
                    </td>
                    <td>
                      <lightning-input
                        type="number"
                        value={product.Price}
                        placeholder="0"
                        data-target-id={product.Id}
                        onchange={handleSalesPriceChange}>
                      </lightning-input>
                    </td>
                    <td>
                      <lightning-input
                        type="date"
                        value={product.PDate}
                        data-target-id={product.Id}
                        onchange={handleDateChange}>
                      </lightning-input>
                    </td>
                    <td>
                      <lightning-input
                        type="text"
                        value={product.LineDescription}
                        data-target-id={product.Id}
                        onchange={handleLineDescriptionChange}>
                      </lightning-input>
                    </td>
                    <td>
                      <lightning-button-icon
                        icon-name="utility:delete"
                        onclick={handleDelete}
                        value={product.Id}
                        data-target-id={product.Id}
                        alternative-text="Delete"
                        class="slds-m-left_xx-small"
                        title="Delete">
                      </lightning-button-icon>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </template>
        </div>

        <!-- Footer -->
        <footer class="slds-modal__footer">
          <template if:false={isFirstPage}>
            <button class="slds-button slds-button_brand slds-float_left" onclick={handleback}>Back</button>
          </template>
          <button class="slds-button slds-button_neutral" onclick={closeModal}>Cancel</button>
          <template if:true={isFirstPage}>
            <button class="slds-button slds-button_brand" onclick={nextDetails} disabled={DisableNext}>Next</button>
          </template>
          <template if:false={isFirstPage}>
            <button class="slds-button slds-button_brand" onclick={saveDetails}>Save</button>
          </template>
        </footer>
      </div>
    </section>

    <!-- Backdrop -->
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
</template>